// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated"
}

datasource db {
  provider = "postgresql"
  // relationMode = "prisma" // Uncomment if not using a real PostgreSQL database
}

// =============================================================================
// Organization Schema
// =============================================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String?  @unique
  logo      String?
  metadata  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members     Member[]
  invitations Invitation[]

  @@map("organization")
}

// =============================================================================
// User & Auth Schema
// =============================================================================

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  emailVerified   Boolean   @default(false) @map("email_verified")
  image           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  username        String?   @unique
  displayUsername String?   @map("display_username")
  role            String?
  banned          Boolean   @default(false)
  banReason       String?   @map("ban_reason")
  banExpires      DateTime? @map("ban_expires")

  sessions          Session[]
  accounts          Account[]
  passkeys          Passkey[]
  apikeys           Apikey[]
  members           Member[]
  invitations       Invitation[]      @relation("Inviter")
  oauthApplications OAuthApplication[]
  oauthAccessTokens OAuthAccessToken[]
  oauthConsents     OAuthConsent[]
  configNamespaces  ConfigNamespace[]
  configs           Config[]
  configHistory     ConfigHistory[]   @relation("ChangedBy")
  aiConversations   AIConversation[]
  aiGenerations     AIGeneration[]
  aiAnalyses        AIAnalysis[]

  @@index([email])
  @@index([username])
  @@map("user")
}

model Session {
  id                   String   @id @default(uuid())
  expiresAt            DateTime @map("expires_at")
  token                String   @unique
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  lastActive           DateTime @default(now()) @map("last_active")
  ipAddress            String?  @map("ip_address")
  userAgent            String?  @map("user_agent")
  userId               String   @map("user_id")
  impersonatedBy       String?  @map("impersonated_by")
  activeOrganizationId String?  @map("active_organization_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  userId                String    @map("user_id")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  idToken               String?   @map("id_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Passkey {
  id           String   @id @default(uuid())
  name         String?
  publicKey    String   @map("public_key")
  userId       String   @map("user_id")
  credentialID String   @map("credential_id")
  counter      Int
  deviceType   String   @map("device_type")
  backedUp     Boolean  @map("backed_up")
  transports   String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  aaguid       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("passkey")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verification")
}

model Apikey {
  id                  String    @id @default(uuid())
  name                String?
  start               String?
  prefix              String?
  key                 String
  userId              String    @map("user_id")
  refillInterval      Int?      @map("refill_interval")
  refillAmount        Int?      @map("refill_amount")
  lastRefillAt        DateTime? @map("last_refill_at")
  enabled             Boolean   @default(true)
  rateLimitEnabled    Boolean   @default(true) @map("rate_limit_enabled")
  rateLimitTimeWindow Int?      @default(86400000) @map("rate_limit_time_window")
  rateLimitMax        Int?      @default(10) @map("rate_limit_max")
  requestCount        Int?      @default(0) @map("request_count")
  remaining           Int?
  lastRequest         DateTime? @map("last_request")
  expiresAt           DateTime? @map("expires_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  permissions         String?
  metadata            String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@map("apikey")
}

model Member {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  role           String   @default("member")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("member")
}

model Invitation {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String
  role           String?
  status         String   @default("pending")
  expiresAt      DateTime @map("expires_at")
  inviterId      String   @map("inviter_id")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

// =============================================================================
// OAuth Schema
// =============================================================================

model OAuthApplication {
  id           String   @id @default(uuid())
  name         String?
  icon         String?
  metadata     String?
  clientId     String?  @unique @map("client_id")
  clientSecret String?  @map("client_secret")
  redirectURLs String?  @map("redirect_u_r_ls")
  type         String?
  disabled     Boolean  @default(false)
  userId       String?  @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user              User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  oauthAccessTokens OAuthAccessToken[]
  oauthConsents     OAuthConsent[]

  @@map("oauth_application")
}

model OAuthAccessToken {
  id                    String    @id @default(uuid())
  accessToken           String?   @unique @map("access_token")
  refreshToken          String?   @unique @map("refresh_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  clientId              String?   @map("client_id")
  userId                String?   @map("user_id")
  scopes                String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  oauthApplication OAuthApplication? @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("oauth_access_token")
}

model OAuthConsent {
  id          String   @id @default(uuid())
  clientId    String?  @map("client_id")
  userId      String?  @map("user_id")
  scopes      String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  consentGiven Boolean? @map("consent_given")

  oauthApplication OAuthApplication? @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("oauth_consent")
}

model JWKS {
  id         String    @id
  publicKey  String    @map("public_key")
  privateKey String    @map("private_key")
  createdAt  DateTime  @map("created_at")
  expiresAt  DateTime? @map("expires_at")

  @@map("jwks")
}

// =============================================================================
// Config Schema
// =============================================================================

model ConfigNamespace {
  id          String   @id @default(uuid())
  name        String
  description String?
  icon        String?
  sortOrder   String?  @default("0") @map("sort_order")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  configs Config[]

  @@index([userId])
  @@index([name])
  @@map("config_namespaces")
}

model Config {
  id          String   @id @default(uuid())
  key         String
  value       String?
  valueType   String   @default("string") @map("value_type")
  description String?
  isSecret    Boolean  @default(false) @map("is_secret")
  metadata    Json?
  namespaceId String   @map("namespace_id")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  namespace ConfigNamespace @relation(fields: [namespaceId], references: [id], onDelete: Cascade)
  history   ConfigHistory[]

  @@index([namespaceId])
  @@index([userId])
  @@index([key])
  @@index([namespaceId, key])
  @@map("configs")
}

model ConfigHistory {
  id            String   @id @default(uuid())
  configId      String   @map("config_id")
  previousValue String?  @map("previous_value")
  newValue      String?  @map("new_value")
  changedBy     String?  @map("changed_by")
  changeReason  String?  @map("change_reason")
  createdAt     DateTime @default(now()) @map("created_at")

  config Config @relation(fields: [configId], references: [id], onDelete: Cascade)
  user   User?  @relation("ChangedBy", fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([configId])
  @@index([changedBy])
  @@map("config_history")
}

// =============================================================================
// Resources Schema
// =============================================================================

model Resources {
  id          String   @id @default(uuid())
  displayName String   @map("display_name")
  isVisible   Boolean  @default(true) @map("is_visible")
  ordering    Int      @default(0)
  schemaName  String   @default("public") @map("schema_name")
  tableName   String   @map("table_name")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([schemaName, tableName])
  @@index([schemaName, tableName])
  @@map("resources")
}

// =============================================================================
// AI Schema
// =============================================================================

model AIConversation {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  model     String
  provider  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AIMessage[]

  @@index([userId])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           String
  content        String
  metadata       Json?
  tokens         Int?
  createdAt      DateTime @default(now()) @map("created_at")

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("ai_messages")
}

model AIGeneration {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  prompt    String
  result    String
  model     String
  provider  String
  tokens    Int?
  cached    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("ai_generations")
}

model AIAnalysis {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  dataType     String   @map("data_type")
  dataSource   String   @map("data_source")
  analysisType String   @map("analysis_type")
  results      Json
  model        String
  tokens       Int?
  cached       Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dataType])
  @@index([analysisType])
  @@index([createdAt])
  @@map("ai_analyses")
}

// =============================================================================
// Vector Schema (stored in public schema with prefix)
// Note: For full vector support, you'll need to use raw queries with pgvector
// =============================================================================

model VectorEmbeddings {
  id        String   @id @default(uuid())
  chunkId   String   @map("chunk_id")
  embedding String?  // Store as string, use raw queries for vector operations
  content   String?
  metadata  Json?
  model     String?
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([chunkId])
  @@index([userId])
  @@index([userId, chunkId])
  @@map("vector_embeddings")
}

model VectorChunks {
  id        String   @id @default(uuid())
  text      String
  index     String
  userId    String   @map("user_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("vector_chunks")
}
